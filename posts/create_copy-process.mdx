---
title: 프로세스의 생성과 복사
description: 프로세스의 생성과 복사를 알아보고, 프로세스 계층 구조도 살펴보자.
createDate: 2022.12.20
tag: 운영체제
---

## 프로세스 생성

1. 사용자가 프로그램을 실행한다.
2. 운영체제가 프로그램의 코드와 데이터를 메모리에 가져오고, 프로세스 제어 블록을 생성한다. 그리고 메모리에 힙 영역과 스택 영역을 확보한다.
3. 준비된 프로세스를 준비 Queue에 삽입한다.

<aside>
❓ **가상 메모리 (Virtual Memory)**  
프로세스가 메모리에 직접 접근하지 못하기 때문에 프로세스가 생성되면 운영체제가 할당해주는 가상 메모리이다. 할당된 가상 메모리 범위 내에서 사용할 수 있고, 해당 프로세스 내 모든 스레드도 마찬가지이다.
데이터 영역, 힙 영역, 스택 영역으로 이루어져 있다. 각 스레드의 개별 메모리 공간은 스택으로 구현된 Thread Local Storage (TLS)이고 공유하는 공간은 힙이다.

</aside>

## 프로세스 복제

### fork() 시스템 호출

커널의 시스템 호출에서 제공하는 fork 함수는 실행 중인 프로세스로부터 새로운 프로세스를 복사한다. (Ctrl + N으로 크롬이나 vscode의 새창을 띄울 때 실행되는 함수이다.)

기존의 프로세스는 부모 프로세스, 복사된 새로 생긴 프로세스는 자식 프로세스가 되어 부모-자식 관계로 연결된다. 프로세스이기 때문에 부모 프로세스와 자식 프로세스는 독립적이다.

> 변경점

- 프로세스 제어 블록이 복사되어 만들어진다.
  - 프로세스 구분자(PID)는 프로세스의 고유 식별자이기 때문에 새로 발급된다.
  - 두 프로세스의 부모와 자식은 다르므로 부모 프로세스 구분자(PPID), 자식 프로세스 구분자(CPID)는 다르다. 기존 프로세스의 CPID는 복사된 프로세스 PID이고, 복사된 프로세스 PPID는 기존 프로세스 PID가 된다.
- 프로세스가 복사되어 새로운 메모리 위치에 만들어진다.
  - 기존 (부모)프로세스의 메모리 위치와 복사된 자식 프로세스의 메모리 위치가 다르므로 메모리 관련 정보가 변경된다.

> 장점

- 하드디스크에서 프로그램을 새로 가져오지 않고 기존 메모리에서 프로세스를 복사하기 때문에 생성 속도가 빠르다.
- 추가 작업 없이 부모 프로세스의 자원을 상속받을 수 있다.
- 자식 프로세스가 종료된 후 사용하던 메모리를 부모 프로세스가 회수함으로써 시스템을 효율적으로 관리할 수 있다.

### exec() 시스템 호출

기존 프로세스를 새로운 프로세스로 전환하는 함수이다. 기존에 만들어진 프로세스의 구조체를 재활용하기 위함이다. 이미 만들어진 프로세스 제어 블록, 메모리 영역, 부모-자식 관계를 그대로 사용할 수 있다.

> 변경점

- 코드 영역이 새로운 코드로 변경된다.
- 코드의 변경에 따라 데이터 영역이 새로운 변수로 채워진다.
- 스택 영역이 초기화된다.
- 각종 레지스터와 사용한 파일 정보가 초기화된다.

## 프로세스 계층 구조

운영체제가 실행될 때 커널이 메모리에 올라와 부팅이 되면 init프로세스를 만든다. 이는 여러 커널 관련 프로세스의 출발점이 된다. fork와 exec 시스템 호출로 init 프로세스를 `복제`하여 나머지 운영체제의 모든 프로세스를 자식 프로세스로 만든다. 이들은 `부모-자식 관계`를 가져 트리구조를 이룬다.

> 장점

- fork로 프로세스를 복제하여 동일한 프로세스를 여러 사용자에게 나누어주어 여러 사용자를 동시에 처리할 수 있다.
- excec로 더이상 사용하지 않는 프로세스의 구조를 재사용할 수 있다.
- fork호출 후 excec를 호출하여 새로운 자식 프로세스를 빠르게 생성할 수 있다.
- 계층구조는 부모-자식간의 관계를 이루기 때문에 종료된 프로세스의 자원을 회수하는데 유용하다.

## 부모-자식 관계와 자원 회수

<aside>
❓ 부모 프로세스가 먼저 종료되면 자식 프로세스를 `고아 프로세스` 라고 하고, 부모가 자식의 자원을 회수하지 않았으면 자식 프로세스는 `좀비 프로세스` 라고 한다.
프로세스 종료 후에도 사용하던 자원이 그대로 남게 되어 자원이 낭비되기 때문에 운영체제는 반환되지 않은 자원을 주기적으로 회수한다.

</aside>

### exit() 시스템 호출

부모 프로세스에게 자식 프로세스가 종료되었음을 알리는 함수이다. 부모 프로세스가 자식 프로세스의 자원을 빨리 회수할 수 있게 해준다.

해당 함수의 인자를 확인하여 자식 프로세스가 어떤 상태로 종료되었는지 파악할 수 있다.

### wait() 시스템 호출

자식 프로세스를 기다리는 함수이다.

자식 프로세스보다 부모 프로세스가 먼저 종료되지 않기 위해 자식 프로세스가 종료될 때까지 기다렸다 부모 프로세스를 실행한다.

부모와 자식 프로세스의 동기화를 위해서도 사용된다. exec() 시스템 호출로 코드 영역이 새로운 코드로 변경되면 처음부터 다시 실행된다. 이때 부모 프로세스에서 wait로 대기하면 해당 위치로 돌아올 수 있다.
